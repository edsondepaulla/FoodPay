<script type="text/javascript">
    var map;
    var markers = [];
    var faisalabad = {lat:31.4181, lng:73.0776};

    function teste(map, marker){
        if(navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                var latlng = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
                marker.setPosition(latlng);
                map.setCenter(latlng);
                map.setZoom(17);
            });
        }
    }

    function addYourLocationButton(map, marker)
    {
        var controlDiv = document.createElement('div');

        var firstChild = document.createElement('button');
        firstChild.style.backgroundColor = '#fff';
        firstChild.style.border = 'none';
        firstChild.style.outline = 'none';
        firstChild.style.width = '28px';
        firstChild.style.height = '28px';
        firstChild.style.borderRadius = '2px';
        firstChild.style.boxShadow = '0 1px 4px rgba(0,0,0,0.3)';
        firstChild.style.cursor = 'pointer';
        firstChild.style.marginRight = '10px';
        firstChild.style.padding = '0px';
        firstChild.title = 'Your Location';
        controlDiv.appendChild(firstChild);

        var secondChild = document.createElement('div');
        secondChild.style.margin = '5px';
        secondChild.style.width = '18px';
        secondChild.style.height = '18px';
        secondChild.style.backgroundImage = 'url(https://maps.gstatic.com/tactile/mylocation/mylocation-sprite-1x.png)';
        secondChild.style.backgroundSize = '180px 18px';
        secondChild.style.backgroundPosition = '-144px 0px';
        secondChild.style.backgroundRepeat = 'no-repeat';
        secondChild.id = 'you_location_img';
        firstChild.appendChild(secondChild);

        firstChild.addEventListener('click', function() {
            teste(map, marker);
        });

        teste(map, marker);

        controlDiv.index = 1;
        map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(controlDiv);
    }

    getpoints_timeout = null;
    function getpoints(time) {
        if (getpoints_timeout)
            clearTimeout(getpoints_timeout);

        getpoints_timeout = setTimeout(function () {
            var bounds = map.getBounds();
            var ne = bounds.getNorthEast();
            var sw = bounds.getSouthWest();
            var nw = new google.maps.LatLng(ne.lat(), sw.lng());
            var se = new google.maps.LatLng(sw.lat(), ne.lng());
            Factory.ajax(
                {
                    action: 'estabecimentos/getpoints',
                    data: {
                        NE_LAT: ne.lat(),
                        SW_LNG: sw.lng(),
                        SW_LAT: sw.lat(),
                        NE_LNG: ne.lng(),
                        IDS_DIF: Object.keys(markers)
                    }
                },
                function (data) {
                    $.each(data.lst, function (index, val) {
                        if(!markers[val.ID]) {
                            var latlng = new google.maps.LatLng(val.LAT, val.LNG);

                            var image = {
                                url: 'https://www.google.com/maps/vt/icon/name=assets/icons/poi/tactile/pinlet_shadow-2-medium.png,assets/icons/poi/tactile/pinlet_outline_v2-2-medium.png,assets/icons/poi/tactile/pinlet-2-medium.png,assets/icons/poi/quantum/pinlet/restaurant_pinlet-2-medium.png&highlight=ff000000,ffffff,db4437,ffffff&color=ff000000?scale=1',
                                labelOrigin: new google.maps.Point(15,40),

                            }
                            var marker = new google.maps.Marker({
                                position: latlng,
                                map: map,
                                icon: image,
                                ID: val.ID,
                                labelClass: "labels",
                                labelStyle: {opacity: 0.75},
                                label: {
                                    text: val.ID+' - '+val.NOME,
                                    fontSize: "15px"
                                }
                            });
                            marker.addListener('click', function () {
                                window.location = '#!/estabelecimento/' + marker.ID;
                            });
                            markers[val.ID] = marker;
                        }
                    });
                }
            );
        }, time?time:500);
    }

    function initMap() {
        navigator.geolocation.getCurrentPosition(function(position){
                map = new google.maps.Map(document.getElementById('map'), {
                    center: {lat: position.coords.latitude, lng: position.coords.longitude},
                    zoom: 17,
                    disableDefaultUI:true
                });
                map.setOptions(
                    {
                        styles: [
                            {
                                featureType: "poi",
                                stylers: [
                                    { visibility: "off" }
                                ]
                            }
                        ]
                    }
                );

                setTimeout(function(){
                    getpoints(1);
                }, 1);

                google.maps.event.addListener(map, 'click', function(event) {
                    //placeMarker(event.latLng);
                    Factory.ajax(
                        {
                            action: 'estabecimentos/setpoint',
                            data: {
                                LAT: event.latLng.lat(),
                                LNG: event.latLng.lng()
                            }
                        },
                        function (data) {
                            getpoints(1);
                        }
                    );
                });

                google.maps.event.addListener(map, 'zoom_changed', function(event) {
                    zoomLevel = map.getZoom();


                    /*
                     if (zoomLevel >= minFTZoomLevel) {
                     FTlayer.setMap(map);
                     } else {
                     FTlayer.setMap(null);
                     }*/

                    getpoints();
                });

                google.maps.event.addListener(map, 'dragend', function(event) {
                    getpoints();
                });

                function placeMarker(location) {
                    var marker = new google.maps.Marker({
                        position: location,
                        map: map
                    });
                }

                    /*var data = "Hello World!";
                     var infowindow = new google.maps.InfoWindow({
                     content: data
                     });*/

                var image = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAABHNCSVQICAgIfAhkiAAAAF96VFh0UmF3IHByb2ZpbGUgdHlwZSBBUFAxAABo3uNKT81LLcpMVigoyk/LzEnlUgADYxMuE0sTS6NEAwMDCwMIMDQwMDYEkkZAtjlUKNEABZgamFmaGZsZmgMxiM8FAEi2FMnxHlGkAAADqElEQVRo3t1aTWgTQRQOiuDPQfHs38GDogc1BwVtQxM9xIMexIN4EWw9iAehuQdq0zb+IYhglFovClXQU+uhIuqh3hQll3iwpyjG38Zkt5uffc4XnHaSbpLZ3dnEZOBB2H3z3jeZN+9vx+fzYPgTtCoQpdVHrtA6EH7jme+/HFFawQBu6BnWNwdGjB2BWH5P32jeb0V4B54KL5uDuW3D7Y/S2uCwvrUR4GaEuZABWS0FHhhd2O4UdN3FMJneLoRtN7Y+GMvvUw2eE2RDh3LTOnCd1vQN5XZ5BXwZMV3QqQT84TFa3zuU39sy8P8IOqHb3T8fpY1emoyMSQGDI/Bwc+0ELy6i4nLtepp2mE0jc5L3UAhMsdxut0rPJfRDN2eMY1enF8Inbmj7XbtZhunkI1rZFD/cmFMlr1PFi1/nzSdGkT5RzcAzvAOPU/kVF9s0ujqw+9mP5QgDmCbJAV7McXIeGpqS3Qg7OVs4lTfMD1Yg9QLR518mZbImFcvWC8FcyLAbsev++3YETb0tn2XAvouAvjGwd14YdCahUTCWW6QQIzzDO/CIAzKm3pf77ei23AUkVbICHr8pnDZNynMQJfYPT7wyKBzPVQG3IvCAtyTsCmRBprQpMawWnkc+q2Rbn+TK/+gmRR7qTYHXEuZkdVM0p6SdLLYqX0LItnFgBxe3v0R04b5mGzwnzIUMPiBbFkdVmhGIa5tkJ4reZvyl4Rg8p3tMBh+FEqUduVRUSTKTnieL58UDG76cc70AyMgIBxs6pMyIYV5agKT9f/ltTnJFOIhuwXOCLD6gQ/oc8AJcdtuYb09xRQN3NWULgCwhfqSk3SkaBZViRTK3EYNUSBF4Hic0Y8mM+if0HhlMlaIHbQ8Z5lszxnGuIP2zrAw8J8jkA7pkMAG79AKuPTOOcgWZeVP5AsSDjAxWegGyJoSUWAj/FBpRa0JiviSbfldMqOMPcce7UVeBLK4gkMVVBLI2phLjKlIJm8lcxMNkLuIomXOTTmc1kwYf2E+nMQdzlaTTKgoaZJWyBQ141RY0DkrK6XflAQbih1geZnhJeXu5WeEZ3mVqSkrIgCzXJaXqoh65TUuLerdtFXgQ2bYKeD1pq6hobLE86SlztXMWvaA5vPO0sYWB9p2K1iJS4ra0Fju/udsN7fWu+MDRFZ+YuuIjX1d8Zu2OD92WC9G3ub1qABktBV7vssfBMX1L7yVjZ7PLHuABb9svezS7boNDyK/b4LdX123+Au+jOmNxrkG0AAAAAElFTkSuQmCC';
                var myMarker = new google.maps.Marker({
                    map: map,
                    position: faisalabad,
                    icon: image
                });
                    /*myMarker.addListener('click', function() {
                     map.setZoom(17);
                     map.setCenter(myMarker.getPosition());

                     console.log(myMarker.teste);

                     alert(myMarker.title);

                     //infowindow.open(map,myMarker);
                     });*/

                addYourLocationButton(map, myMarker);
            },
        function(error){ // callback de erro

        });
    }
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAmC5dvFmNrc8sQ5Y5UtJfldKbc4O9Hq6g&libraries=geometry&callback=initMap" async defer></script>